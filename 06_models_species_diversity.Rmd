---
title: "06_models_species_diversity"
output: word_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## ------------- head data ----------------
```{r}

head(data_plots3)

```


<!-- ## ----------- Test for data distribution/ screwness --------- -->
<!-- ```{r} -->
<!-- library(fitdistrplus) -->

<!-- ## If discrete is TRUE, the represented distributions are the Poisson, negative binomial distributions, and the normal distribution to which previous discrete distributions may converge. If discrete is FALSE, these are uniform, normal, logistic, lognormal, beta and gamma distributions. -->

<!-- # discrete = FALSE -->
<!-- descdist(data_plots3$shannon, discrete = FALSE, boot = 500) # Normal, maybe lognormal -->
<!-- descdist(data_plots3$simpson, discrete = FALSE, boot = 500) # beta -->
<!-- descdist(data_plots3$sr_margalef, discrete = FALSE, boot = 500) # beta, maybe normal -->
<!-- descdist(data_plots3$sr_menhinick, discrete = FALSE, boot = 500) # lognormal -->

<!-- # discrete = TRUE -->
<!-- descdist(data_plots3$shannon, discrete = TRUE, boot = 500) # neg. binomial -->
<!-- descdist(data_plots3$simpson, discrete = TRUE, boot = 500) # neg. binomial -->
<!-- descdist(data_plots3$sr_margalef, discrete = TRUE, boot = 500) # normal or poisson -->
<!-- descdist(data_plots3$sr_menhinick, discrete = TRUE, boot = 500) # neg. binomial -->

<!-- ``` -->


## correlation
```{r}
# cor_df <- data.frame(data_plots3$bare_soil_c, data_plots3$dist_int_veg, data_plots3$field_layer_c, data_plots3$shrub_layer_c, data_plots3$tree_layer_c, data_plots3$caco, data_plots3$slope, data_plots3$loi, data_plots3$mean_cover, data_plots3$sd_cover, data_plots3$total_cover_layers, data_plots3$shannon, data_plots3$simpson, data_plots3$sr_margalef, data_plots3$sr_menhinick)
# 
# res <- cor(cor_df)
# 
# library(Hmisc)
# library(corrplot)
# corrplot(res)

```




## -------------------- Linear mixed model with gmnds axis scores from AXIS 1 as response (all plots) -------------------
```{r}
lmer_method1 <- lmer(mean_gnmds1 ~ method + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_dist_int_veg1 <- lmer(mean_gnmds1 ~ dist_int_veg + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_loi1 <- lmer(mean_gnmds1 ~ loi + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_caco1 <- lmer(mean_gnmds1 ~ caco + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_expo1 <- lmer(mean_gnmds1 ~ exposure + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_grain_size1 <- lmer(mean_gnmds1 ~ grain_size_stand_f + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_site_type1 <- lmer(mean_gnmds1 ~ site_type + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_year1 <- lmer(mean_gnmds1 ~ year + (1|site_id_new.x), data = env.var_full_sub5, REML = F)


AIC(lmer_method1, lmer_loi1, lmer_caco1, lmer_expo1, lmer_grain_size1, lmer_site_type1, lmer_year1)
anova(lmer_method, lmer_loi)
anova(lmer_method, lmer_caco)
anova(lmer_method, lmer_dist_int_veg)


lmerfull1 <- lmer(mean_gnmds1 ~ dist_int_veg + loi + caco + exposure + grain_size_stand_f + method + site_type + year + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
summary(lmerfull)

m1_a1 <- lmer(mean_gnmds1 ~ method + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
m2_a1 <- lmer(mean_gnmds1 ~ method + caco + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
m3_a1 <- lmer(mean_gnmds1 ~ method + caco + loi + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
m4_a1 <- lmer(mean_gnmds1 ~ method + caco + loi + exposure + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
m5_a1 <- lmer(mean_gnmds1 ~ method + caco + loi + exposure + year + (1|site_id_new.x), data = env.var_full_sub5, REML = F)


AIC(m1_a1, m2_a1, m3_a1, m4_a1, m5_a1)
#       df      AIC
# m1_a1  6 274.1463
# m2_a1  7 251.9221
# m3_a1  8 248.5197  # BEST
# m4_a1 16 255.9748
# m5_a1 22 249.9681  # 2nd


summary(m3_a1)

```



## -------------------- Linear mixed model with gmnds axis scores from AXIS 2 as response (all plots) -------------------
```{r}
lmer_method2 <- lmer(mean_gnmds2 ~ method + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_dist_int_veg1 <- lmer(mean_gnmds2 ~ dist_int_veg + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_loi2 <- lmer(mean_gnmds2 ~ loi + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_caco2 <- lmer(mean_gnmds2 ~ caco + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_expo2 <- lmer(mean_gnmds2 ~ exposure + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_grain_size2 <- lmer(mean_gnmds2 ~ grain_size_stand_f + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_site_type2 <- lmer(mean_gnmds2 ~ site_type + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
lmer_year2 <- lmer(mean_gnmds2 ~ year + (1|site_id_new.x), data = env.var_full_sub5, REML = F)


AIC(lmer_method2, lmer_loi2, lmer_caco2, lmer_expo2, lmer_grain_size2, lmer_site_type2, lmer_year2)
anova(lmer_caco2, lmer_loi2)
anova(lmer_site_type2, lmer_loi2)


lmerfull2 <- lmer(mean_gnmds2 ~ dist_int_veg + loi + caco + exposure + grain_size_stand_f + method + site_type + year + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
summary(lmerfull)

m1_a2 <- lmer(mean_gnmds2 ~ method + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
m2_a2 <- lmer(mean_gnmds2 ~ method + caco + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
m3_a2 <- lmer(mean_gnmds2 ~ method + caco + loi + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
m4_a2 <- lmer(mean_gnmds2 ~ method + caco + loi + exposure + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
m5_a2 <- lmer(mean_gnmds2 ~ method + caco + loi + exposure + year + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
m6_a2 <- lmer(mean_gnmds2 ~ method + caco + loi + site_type + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
m7_a2 <- lmer(mean_gnmds2 ~ method + caco + loi + site_type + exposure + (1|site_id_new.x), data = env.var_full_sub5, REML = F)
m8_a2 <- lmer(mean_gnmds2 ~ method + caco + loi + site_type + exposure + year + (1|site_id_new.x), data = env.var_full_sub5, REML = F)


AIC(m1_a2, m2_a2, m3_a2, m4_a2, m5_a2, m6_a2, m7_a2, m8_a2)
#       df      AIC
# m1_a2  6 322.3958  # BEST
# m2_a2  7 323.4603
# m3_a2  8 323.3754  # 2nd
# m4_a2 16 330.8082
# m5_a2 22 335.9778
# m6_a2  9 325.3553
# m7_a2 17 332.8054
# m8_a2 23 337.9731


summary(m1_a2)
summary(m3_a2)

```




## -------------------- Linear mixed model with "shannon" as response (all plots) -------------------

```{r}
library(lme4)
library(lmerTest)


lm0_sh <- lmer(shannon ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + (1|site_id), data = data_plots3, REML = F)

lm1 <- lmer(shannon ~ dist_int_veg + total_cover_layers  + caco + exposure + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F)
lm2 <- lmer(shannon ~ dist_int_veg + total_cover_layers  + caco + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F) 
lm3 <- lmer(shannon ~ dist_int_veg + total_cover_layers  + caco + exposure + (1|site_id), data = data_plots3, REML = F)
lm4_shannon <- lmer(shannon ~ log(dist_int_veg+1) + total_cover_layers  + caco + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F) #1
lm5 <- lmer(shannon ~ log(dist_int_veg+1) + total_cover_layers  + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F) #2

lm4_reml <- lmer(shannon ~ log(dist_int_veg+1) + total_cover_layers  + caco + grain_size_stand_f + (1|site_id), data = data_plots3, REML = T) #1

```



#### random factor selection
```{r}
library(lmerTest)
AIC(lm1_rand, lm2_rand)
#          df      AIC
# lm1_rand 23 275.2039
# lm2_rand 23 282.9316

```



#### model selection 
```{r}
drop1(lm0)

s <- step(lm0)
plot(s)

library(AICcmodavg)
AIC(lm2, lm4)

Cand.models <- list( )
Cand.models[[1]] <- lmer(shannon ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + (1|site_id), data = data_plots3, REML = F)
Cand.models[[2]] <- lmer(shannon ~ dist_int_veg + total_cover_layers  + caco + exposure + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F)
Cand.models[[3]] <- lmer(shannon ~ dist_int_veg + total_cover_layers  + caco + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F) 
Cand.models[[4]] <- lmer(shannon ~ dist_int_veg + total_cover_layers  + caco + exposure + (1|site_id), data = data_plots3, REML = F)
Cand.models[[5]] <- lmer(shannon ~ log(dist_int_veg+1) + total_cover_layers  + caco + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F) #1
Cand.models[[6]] <- lmer(shannon ~ log(dist_int_veg+1) + total_cover_layers  + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F) 


aictab(Cand.models, second.ord = F) 
# Model selection based on AIC:
# 
#       K    AIC Delta_AIC AICWt Cum.Wt      LL
# Mod5 10 255.38      0.00  0.68   0.68 -117.69
# Mod6 11 256.94      1.55  0.31   1.00 -117.47
# Mod3 10 265.91     10.53  0.00   1.00 -122.96
# Mod2 18 273.63     18.24  0.00   1.00 -118.81
# Mod1 23 274.76     19.38  0.00   1.00 -114.38
# Mod4 14 276.87     21.49  0.00   1.00 -124.44


summary(lm0) #full

summary(lm5) #2
summary(lm4) #1
summary(lm4_reml) #1

```

#### Checking assumptions
```{r}
library(sjPlot)
plot_model(lm4_reml, type = "diag")

```


#### Plot results
```{r}
plot_model(lm4, type = "est", show.intercept = T)
plot_model(lm4, type = "eff")


```







## -------------------- Linear mixed model with "sr_menhinick" as response (all plots) -------------------

```{r}
library(lme4)
library(lmerTest)

#### random factor selection ----
lm0_rand <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + site_type + (1|site_id/plot_id), data = data_plots3, REML = F) # Error: number of levels of each grouping factor must be < number of observations (problems: plotnumb:siteID)

lm1_rand <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + site_type + (1|site_id), data = data_plots3, REML = F) #1

lm2_rand <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + site_type +(1|plot_id), data = data_plots3, REML = F)



#### models ----
lm0 <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + (1|site_id), data = data_plots3, REML = F)

lm1 <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + caco + exposure + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F)
lm2 <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + caco + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F) 
lm3 <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F)
lm4_sr_menhinick <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F) #1
lm5 <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers + caco + grain_size_stand_f + log(loi+1) + method + (1|site_id), data = data_plots3, REML = F) #3
lm6 <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F) #2


lm4_reml <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers  + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = T) #1

```



#### random factor selection
```{r}
library(lmerTest)
AIC(lm1_rand, lm2_rand)
#          df      AIC
# lm1_rand 23 275.2039
# lm2_rand 23 282.9316

```



#### model selection 
```{r}
drop1(lm0)

s <- step(lm0)
plot(s)

library(AICcmodavg)
AIC(lm2, lm4)

Cand.models <- list( )
Cand.models[[1]] <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + (1|site_id), data = data_plots3, REML = F)
Cand.models[[2]] <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + caco + exposure + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F)
Cand.models[[3]] <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers  + caco + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F)
Cand.models[[4]] <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F)
Cand.models[[5]] <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers  + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F)
Cand.models[[6]] <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers  + caco + grain_size_stand_f + log(loi+1) + method + (1|site_id), data = data_plots3, REML = F)
Cand.models[[7]] <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F)


aictab(Cand.models, second.ord = F) 
# Model selection based on AIC:
# 
#       K    AIC Delta_AIC AICWt Cum.Wt     LL
# Mod5 11 125.05      0.00  0.49   0.49 -51.52
# Mod7 10 125.27      0.22  0.43   0.92 -52.64
# Mod6 13 128.98      3.94  0.07   0.99 -51.49
# Mod4 11 132.85      7.81  0.01   1.00 -55.43
# Mod3 10 136.47     11.42  0.00   1.00 -58.23
# Mod2 18 146.60     21.55  0.00   1.00 -55.30
# Mod1 23 151.84     26.79  0.00   1.00 -52.92


summary(lm0) #full

summary(lm6) #2
summary(lm4) #1
summary(lm4_reml) #1

```

#### Checking assumptions
```{r}
library(sjPlot)
plot_model(lm4_reml, type = "diag")

```


#### Plot results
```{r}
plot_model(lm4_reml, type = "est", show.intercept = T)
plot_model(lm4_reml, type = "eff")


```








###################### Not done yet!!!!!!!!

## -------------------- (Generalized) linear mixed model with "simpson" as response (all plots) -------------------

```{r}
library(glmmTMB)
library(betareg)
library("lmtest")

glm0_rand <- glmmTMB(simpson ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + site_type + (1|site_id), data = data_plots3, family = beta_family(link = "logit")) # Error in eval(family$initialize) : y values must be 0 < y < 1 ---> y is min 0 and max 0.8907328


lm0_rand <- lmer(simpson ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + site_type + (1|site_id), data = data_plots3, REML = F)


#### random factor selection ----
lm0_rand <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + site_type + (1|site_id/plot_id), data = data_plots3, REML = F) # Error: number of levels of each grouping factor must be < number of observations (problems: plotnumb:siteID)

lm1_rand <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + site_type + (1|site_id), data = data_plots3, REML = F) #1

lm2_rand <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + site_type +(1|plot_id), data = data_plots3, REML = F)



#### models ----

glm0_beta <- glmmTMB(simpson ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + site_type + (1|site_id), data = data_plots3, family = nbinom2())





lm0 <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + (1|site_id), data = data_plots3, REML = F)

lm1 <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + caco + exposure + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F)
lm2 <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + caco + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F) 
lm3 <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F)
lm4 <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F) #1
lm5 <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers + caco + grain_size_stand_f + log(loi+1) + method + (1|site_id), data = data_plots3, REML = F) #3
lm6 <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F) #2


lm4_reml <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers  + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = T) #1

```



#### random factor selection
```{r}
library(lmerTest)
AIC(lm1_rand, lm2_rand)
#          df      AIC
# lm1_rand 23 275.2039
# lm2_rand 23 282.9316

```



#### model selection 
```{r}
drop1(lm0)

s <- step(lm0)
plot(s)

library(AICcmodavg)
AIC(lm2, lm4)

Cand.models <- list( )
Cand.models[[1]] <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + field_layer_h + caco + slope + exposure + grain_size_stand_f + loi + method + (1|site_id), data = data_plots3, REML = F)
Cand.models[[2]] <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + caco + exposure + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F)
Cand.models[[3]] <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers  + caco + grain_size_stand_f + (1|site_id), data = data_plots3, REML = F)
Cand.models[[4]] <- lmer(sr_menhinick ~ dist_int_veg + total_cover_layers + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F)
Cand.models[[5]] <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers  + caco + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F)
Cand.models[[6]] <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers  + caco + grain_size_stand_f + log(loi+1) + method + (1|site_id), data = data_plots3, REML = F)
Cand.models[[7]] <- lmer(sr_menhinick ~ log(dist_int_veg+1) + total_cover_layers + grain_size_stand_f + log(loi+1) + (1|site_id), data = data_plots3, REML = F)


aictab(Cand.models, second.ord = F) 
# Model selection based on AIC:
# 
#       K    AIC Delta_AIC AICWt Cum.Wt     LL
# Mod5 11 125.05      0.00  0.49   0.49 -51.52
# Mod7 10 125.27      0.22  0.43   0.92 -52.64
# Mod6 13 128.98      3.94  0.07   0.99 -51.49
# Mod4 11 132.85      7.81  0.01   1.00 -55.43
# Mod3 10 136.47     11.42  0.00   1.00 -58.23
# Mod2 18 146.60     21.55  0.00   1.00 -55.30
# Mod1 23 151.84     26.79  0.00   1.00 -52.92


summary(lm0) #full

summary(lm6) #2
summary(lm4) #1
summary(lm4_reml) #1

```

#### Checking assumptions
```{r}
library(sjPlot)
plot_model(lm4_reml, type = "diag")

```


#### Plot results
```{r}
plot_model(lm4_reml, type = "est", show.intercept = T)
plot_model(lm4_reml, type = "eff")


```